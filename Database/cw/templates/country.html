<!DOCTYPE html>
<html>

<head>
  <title>Country</title>
  <link href="./templates/style.css" rel="stylesheet" type="text/css" />
</head>


<script src="./templates/components/nav.js" type="text/javascript" defer></script>
<script src="./templates/components/table.js" type="text/javascript" defer></script>
<script src="./templates/components/select.js" type="text/javascript" defer></script>

<style>
  .countryContainer {
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    width: 100%;
    padding: 20px;
  }

  #country {
    padding: 10px;
  }
</style>

<script defer>
  function filterCase() {
    const selectedDate = document.getElementById('covidDate').value
    const selectedCountry = document.getElementById('country').value

    return fetch(`/api/covid/country?date=${selectedDate}&iso_code=${selectedCountry}`)
      .then((response) => response.json())
      .then(({ covid, totalCovid }) => {
        covid.push({ date: '<b>Total</b>', ...totalCovid })
        const header = selectedDate !== 'all' ? ['Date', 'Total Case', 'Total Death', 'Stringency Index'] : ['Date', 'Total Case', 'Total Death']
        loadTable(covid, header, 'covid')
      })
  }

  function filterVaccination() {
    const selectedDate = document.getElementById('totalVaccinationDate').value
    const selectedCountry = document.getElementById('country').value

    return fetch(`/api/vaccination/country?date=${selectedDate}&iso_code=${selectedCountry}`)
      .then(response => response.json())
      .then(({ vaccination, totalVaccination }) => {
        vaccination.push({ date: '<b>Total</b>', ...totalVaccination })
        loadTable(vaccination, ['Date', 'Total Vaccination', 'Total Unique Vaccinated People'], 'vaccination')
      })
  }

  function filterTest(){
     const selectedDate = document.getElementById('testDate').value
    const selectedCountry = document.getElementById('country').value

    return fetch(`/api/test/?date=${selectedDate}&iso_code=${selectedCountry}`)
      .then(response => response.json())
      .then(({ test }) => {
        loadTable(test, ['Date', 'Daily Test', 'Positive Rate'], 'test')
      })
  }
  
  function filterHospitalize(){
     const selectedDate = document.getElementById('hospitalizeDate').value
    const selectedCountry = document.getElementById('country').value

    return fetch(`/api/hospitalize/country?date=${selectedDate}&iso_code=${selectedCountry}`)
      .then(response => response.json())
      .then(({ hospitalize,totalHospitalize }) => {
        hospitalize.push({ date: '<b>Total</b>', ...totalHospitalize })
        loadTable(hospitalize, ['Date', 'Hospital Patients', 'ICU Patients'], 'hospitalize')
      })
  }

  function filterByCountry() {
    const selectedCountry = document.getElementById('country')
    return Promise.all([
      filterCase(),
      filterVaccination(),
      filterTest(),
      filterHospitalize(),
      fetch(`/api/population/country?iso_code=${selectedCountry.value}`)
        .then(response => response.json())
        .then(({ population }) => {
          const populationText = document.getElementById('population')
          const populationDensityText = document.getElementById('populationDensity')
          const seniorPopulationText = document.getElementById('seniorPopulation')
          const lifeExpectancyText = document.getElementById('lifeExpectancy')
          
          populationText.textContent = `Population: ${population.total_population}`
          populationDensityText.textContent = `Population Density: ${population.population_density}`
          seniorPopulationText.textContent = `Age 65 And Above Population: ${population.aged_65_older}`
          lifeExpectancyText.textContent = `Life Expectancy: ${population.life_expectancy}`

        }),
      fetch(`/api/facility/${selectedCountry.value}`)
        .then(response=>response.json())
        .then(({facilities})=>{
          const handwashFacilitiesText = document.getElementById('handwashFacilities')
          const hospitalBedText = document.getElementById('hospitalBed')

          handwashFacilitiesText.textContent = `Handwash Facility: ${facilities.handwashing_facilities}`
          hospitalBedText.textContent = `Hospital Beds Per Thousands: ${facilities.hospital_beds_per_thousand}`
        }),
    ])
  }

</script>

<body>
  <div id="myNav"></div>
  <div class="container">
    <h1>Country Data</h1>

    <div class="countryContainer">
      <h1>Country:<h1>
          <select name="Country" id="country" onchange="filterByCountry()">
            {{#countries}}
            <option value="{{iso_code}}">{{location}}</option>
            {{/countries}}
          </select>
    </div>

    <div class="row" style="padding-bottom:10px; justify-content: space-between;">
      <h3 id="population">Population: {{population.total_population}}</h3>
      <h3 id="populationDensity">Population Density: {{population.population_density}}</h3>
      <h3 id="seniorPopulation">Age 65 And Above Population: {{population.aged_65_older}}</h3>
      <h3 id="lifeExpectancy">Life Expectancy: {{population.life_expectancy}}</h3>
    </div>
    
    <div class="row" style="padding-bottom:10px; justify-content:space-between;">
      <h3 id="handwashFacilities">Handwash Facility: {{facilities.handwashing_facilities}}</h3>
      <h3 id="hospitalBed">Hospital Beds Per Thousands: {{facilities.hospital_beds_per_thousand}}</h3>
    </div>
    <div class="row">
      <div class="container" style="margin-right:50px;">
        <div class="titleContainer">
          <h3>Covid Cases</h3>
          <div>
            Filter:
            <select name="Filter By Date" id="covidDate" onchange="filterCase()">
              <option value="all">All</option>
              {{#covid}}
              <option value="{{date}}">{{date}}</option>
              {{/covid}}
            </select>
          </div>
        </div>

        <table id="covid" border="solid">
          <tr>
            <th>Date</th>
            <th>Total Case</th>
            <th>Total Death</th>
          </tr>

          {{#covid}}
          <tr>
            <td>{{date}}</td>
            <td>{{total_case}}</td>
            <td>{{total_death}}</td>
          </tr>
          {{/covid}}

          <tr>
            <td><b>Total</b></td>
            <td>{{totalCovid.total_case}}</td>
            <td>{{totalCovid.total_death}}</td>
          </tr>

        </table>
      </div>

      <div class="container">
        <div class="titleContainer">
          <h3>Vaccination</h3>
          <div>
            Filter:
            <select name="Filter By Date" id="totalVaccinationDate" onchange="filterVaccination()">
              <option value="all">All</option>
              {{#vaccination}}
              <option value="{{date}}">{{date}}</option>
              {{/vaccination}}
            </select>
          </div>
        </div>

        <table id="vaccination" border="solid">
          <tr>
            <th>Date</th>
            <th>Total Vaccination</th>
            <th>Total Unique Vaccinated People</th>
          </tr>

          {{#vaccination}}
          <tr>
            <td>{{date}}</td>
            <td>{{total_vaccinations}}</td>
            <td>{{total_unique_vaccinated_people}}</td>
          </tr>
          {{/vaccination}}

          <tr>
            <td><b>Total</b></td>
            <td>{{totalVaccination.total_vaccinations}}</td>
            <td>{{totalVaccination.total_unique_vaccinated_people}}</td>
          </tr>

        </table>
      </div>
    </div>

    <div class="row" style="margin-top:20px;">
      <div class="container" style="margin-right:50px;">
        <div class="titleContainer">
          <h3>Hospitalize</h3>
          <div>
            Filter:
            <select name="Filter By Date" id="hospitalizeDate" onchange="filterHospitalize()">
              <option value="all">All</option>
              {{#hospitalize}}
              <option value="{{date}}">{{date}}</option>
              {{/hospitalize}}
            </select>
          </div>
        </div>

        <table id="hospitalize" border="solid">
          <tr>
            <th>Date</th>
            <th>Hospital Patients</th>
            <th>ICU Patients</th>
          </tr>

          {{#hospitalize}}
          <tr>
            <td>{{date}}</td>
            <td>{{total_icu_patient}}</td>
            <td>{{total_hosp_patients}}</td>
          </tr>
          {{/hospitalize}}

          <tr>
            <td><b>Total</b></td>
            <td>{{totalHospitalize.total_icu_patient}}</td>
            <td>{{totalHospitalize.total_hosp_patients}}</td>
          </tr>

        </table>
      </div>

      <div class="container">
        <div class="titleContainer">
          <h3>Test</h3>
          <div>
            Filter:
            <select name="Filter By Date" id="testDate" onchange="filterTest()">
              {{#testDateList}}
              <option value="{{date}}">{{date}}</option>
              {{/testDateList}}
            </select>
          </div>
        </div>

        <table id="test" border="solid">
          <tr>
            <th>Date</th>
            <th>Daily Test</th>
            <th>Positive Rate</th>
          </tr>

          {{#test}}
          <tr>
            <td>{{date}}</td>
            <td>{{new_tests}}</td>
            <td>{{positive_rate}}</td>
          </tr>
          {{/test}}

        </table>
      </div>
    </div>
  </div>
</body>

</html>